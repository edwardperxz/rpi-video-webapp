<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Raspberry Pi System Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            padding: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            margin-bottom: 0.25rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem 0;
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .card h2 {
            margin: 0 0 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
        }

        .stat {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--border);
        }

        .stat:last-child {
            border-bottom: none;
        }

        pre {
            white-space: pre-wrap;
            word-break: break-word;
            background: var(--surface);
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .processes {
            max-height: 220px;
            overflow: auto;
            padding-right: 0.5rem;
        }

        .processes::-webkit-scrollbar {
            width: 8px;
        }

        .processes::-webkit-scrollbar-track {
            background: var(--surface);
            border-radius: 4px;
        }

        .processes::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .small {
            font-size: 0.9rem;
            color: var(--muted);
            min-width: 120px;
        }

        .flag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-right: 0.35rem;
            font-size: 0.8rem;
        }

        .ok {
            background: var(--accent-2);
            color: var(--card);
            opacity: 0.8;
        }

        .warn {
            background: var(--accent);
            color: var(--card);
        }

        .memory-bar {
            width: 100%;
            height: 12px;
            background: var(--surface);
            border-radius: 6px;
            margin: 0.75rem 0 1rem;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        #memory-bars {
            width: 100%;
            height: 100%;
            display: flex;
        }

        .memory-used {
            background: var(--accent);
            height: 100%;
            opacity: 0.8;
        }

        .memory-cached {
            background: var(--accent-2);
            height: 100%;
            opacity: 0.6;
        }

        .memory-buffers {
            background: var(--accent-2);
            height: 100%;
            opacity: 0.4;
        }

        .freq-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .freq-chip {
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
        }

        .hardware-info {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.75rem;
            font-family: monospace;
            font-size: 0.9rem;
            color: var(--text);
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Raspberry Pi System Dashboard</h1>
            <p class="muted">Live system telemetry (updates every 5s) — data provided by the server's
                <code>/api/system</code> endpoint.
            </p>
        </header>

        <main class="grid" id="dashboard">
            <section class="card">
                <h2>Overview</h2>
                <div class="stat">
                    <div class="small">CPU Usage</div>
                    <div id="cpu-usage">—</div>
                </div>
                <div class="stat">
                    <div class="small">CPU Temp</div>
                    <div id="cpu-temp">—</div>
                </div>
                <div class="stat">
                    <div class="small">Load Avg (1/5/15)</div>
                    <div id="load-avg">—</div>
                </div>
                <div class="stat">
                    <div class="small">Uptime</div>
                    <div id="uptime">—</div>
                </div>
                <div class="stat">
                    <div class="small">CPU Model</div>
                    <div id="cpu-model">—</div>
                </div>
            </section>

            <section class="card">
                <h2>Memory</h2>
                <div class="memory-bar">
                    <div id="memory-bars">
                        <div class="memory-used"></div>
                        <div class="memory-cached"></div>
                        <div class="memory-buffers"></div>
                    </div>
                </div>
                <div class="stat">
                    <div class="small">Total</div>
                    <div id="mem-total">—</div>
                </div>
                <div class="stat">
                    <div class="small">Used</div>
                    <div id="mem-used">—</div>
                </div>
                <div class="stat">
                    <div class="small">Free</div>
                    <div id="mem-free">—</div>
                </div>
                <div class="stat">
                    <div class="small">Cached</div>
                    <div id="mem-cached">—</div>
                </div>
                <div class="stat">
                    <div class="small">Buffers</div>
                    <div id="mem-buffers">—</div>
                </div>
                <div style="margin-top:0.5rem">
                    <div class="stat">
                        <div class="small">Swap Total</div>
                        <div id="swap-total">—</div>
                    </div>
                    <div class="stat">
                        <div class="small">Swap Used</div>
                        <div id="swap-used">—</div>
                    </div>
                </div>
                <div style="margin-top:0.5rem">
                    <div class="stat">
                        <div class="small">Memory Split (ARM/GPU)</div>
                        <div id="memory-split">—</div>
                    </div>
                </div>
            </section>

            <section class="card">
                <h2>System Status</h2>
                <div class="stat">
                    <div class="small">Voltage</div>
                    <div id="voltage">—</div>
                </div>
                <div class="stat">
                    <div class="small">ARM Clock</div>
                    <div id="arm-clock">—</div>
                </div>
                <div class="stat">
                    <div class="small">Core Clock</div>
                    <div id="core-clock">—</div>
                </div>
                <div class="stat">
                    <div class="small">Governor</div>
                    <div id="governor">—</div>
                </div>
                <div style="margin-top:0.5rem">
                    <strong>Available Frequencies</strong>
                    <div id="available-freqs" class="freq-list">—</div>
                </div>
                <div style="margin-top:0.5rem">
                    <strong>GPU</strong>
                    <div class="stat">
                        <div class="small">Memory</div>
                        <div id="gpu-mem">—</div>
                    </div>
                    <div class="stat">
                        <div class="small">Core Freq</div>
                        <div id="gpu-freq">—</div>
                    </div>
                    <div class="stat">
                        <div class="small">Codecs</div>
                        <div id="gpu-codecs">—</div>
                    </div>
                </div>
                <div style="margin-top:0.5rem">
                    <strong>Power State</strong>
                    <div id="power-state"></div>
                </div>
            </section>

            <section class="card">
                <h2>Hardware Info</h2>
                <div class="stat">
                    <div class="small">Model</div>
                    <div id="pi-model">—</div>
                </div>
                <div class="stat">
                    <div class="small">Hardware Rev</div>
                    <div id="pi-revision">—</div>
                </div>
                <div class="stat">
                    <div class="small">Serial</div>
                    <div id="pi-serial">—</div>
                </div>
                <div class="hardware-info" id="firmware-info">—</div>
            </section>

            <section class="card">
                <h2>Storage</h2>
                <div class="stat">
                    <div class="small">Filesystem</div>
                    <div id="disk-fs">—</div>
                </div>
                <div class="stat">
                    <div class="small">Size</div>
                    <div id="disk-size">—</div>
                </div>
                <div class="stat">
                    <div class="small">Used</div>
                    <div id="disk-used">—</div>
                </div>
                <div class="stat">
                    <div class="small">Available</div>
                    <div id="disk-available">—</div>
                </div>
                <div class="stat">
                    <div class="small">Percent</div>
                    <div id="disk-percent">—</div>
                </div>
            </section>

            <section class="card">
                <h2>Network</h2>
                <div id="network-interfaces" class="small muted">Loading interfaces...</div>
                <h3 style="margin-top:0.6rem">Traffic (bytes)</h3>
                <div id="net-traffic" class="small">—</div>
                <div style="margin-top:0.6rem"><strong>Wireless signal (dBm)</strong>: <span id="wireless">—</span>
                </div>
            </section>

            <section class="card">
                <h2>Top Processes</h2>
                <div class="processes" id="processes">Loading...</div>
            </section>

            <section class="card">
                <h2>Raw JSON</h2>
                <pre id="raw">—</pre>
            </section>
        </main>

        <footer style="margin-top:1rem; text-align:center; color:#8fa6bf;">Dashboard generated from
            <code>/api/system</code>
        </footer>
    </div>

    <script>
        function formatBytes(bytes) {
            if (bytes === null || bytes === undefined) return '—';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let i = 0; let value = bytes;
            while (value >= 1024 && i < units.length - 1) { value /= 1024; i++; }
            return value.toFixed(1) + ' ' + units[i];
        }

        function toPercent(value) {
            if (value === null || value === undefined) return '—';
            return (value * 100).toFixed(1) + '%';
        }

        function parseThrottled(hex) {
            if (!hex) return {};
            let v = 0;
            try { v = parseInt(hex, 16); } catch (e) { return {}; }
            return {
                underVoltageNow: Boolean(v & 0x1),
                freqCappedNow: Boolean(v & 0x2),
                throttledNow: Boolean(v & 0x4),
                underVoltageOccurred: Boolean(v & 0x10000),
                freqCappedOccurred: Boolean(v & 0x20000),
                throttledOccurred: Boolean(v & 0x40000)
            };
        }

        async function update() {
            try {
                const res = await fetch('/api/system');
                if (!res.ok) throw new Error('Network response not ok');
                const data = await res.json();

                // Overview
                document.getElementById('cpu-usage').textContent = toPercent(data.cpuUsage);
                document.getElementById('cpu-temp').textContent = data.cpuTemp ? data.cpuTemp.toFixed(1) + ' °C' : '—';
                document.getElementById('load-avg').textContent = data.loadAvg ? `${data.loadAvg['1min'].toFixed(2)} / ${data.loadAvg['5min'].toFixed(2)} / ${data.loadAvg['15min'].toFixed(2)}` : '—';
                document.getElementById('uptime').textContent = data.uptimeHuman || '—';
                document.getElementById('cpu-model').textContent = data.cpuModel || '—';

                // Memory
                document.getElementById('mem-total').textContent = formatBytes(data.memory.total);
                document.getElementById('mem-used').textContent = formatBytes(data.memory.used);
                document.getElementById('mem-free').textContent = formatBytes(data.memory.free);
                document.getElementById('mem-cached').textContent = formatBytes(data.memory.cached);
                document.getElementById('mem-buffers').textContent = formatBytes(data.memory.buffers);
                document.getElementById('swap-total').textContent = formatBytes(data.memory.swapTotal);
                document.getElementById('swap-used').textContent = formatBytes(data.memory.swapUsed);
                document.getElementById('memory-split').textContent = data.memorySplit || '—';

                // Update memory visualization
                if (data.memory.total) {
                    const memBars = document.getElementById('memory-bars');
                    const total = data.memory.total;

                    const usedBar = memBars.querySelector('.memory-used');
                    const cachedBar = memBars.querySelector('.memory-cached');
                    const buffersBar = memBars.querySelector('.memory-buffers');

                    usedBar.style.width = (data.memory.used / total * 100) + '%';
                    cachedBar.style.width = (data.memory.cached / total * 100) + '%';
                    buffersBar.style.width = (data.memory.buffers / total * 100) + '%';
                }

                // System Status
                document.getElementById('voltage').textContent = data.voltage ? data.voltage + ' V' : '—';
                document.getElementById('arm-clock').textContent = data.armClock ? (data.armClock / 1e6).toFixed(0) + ' MHz' : '—';
                document.getElementById('core-clock').textContent = data.coreClock ? (data.coreClock / 1e6).toFixed(0) + ' MHz' : '—';
                document.getElementById('governor').textContent = data.governor || '—';

                // Available frequencies
                if (Array.isArray(data.availableFrequencies)) {
                    const freqList = document.getElementById('available-freqs');
                    freqList.innerHTML = data.availableFrequencies
                        .map(f => `<span class="freq-chip">${(f / 1e6).toFixed(0)} MHz</span>`)
                        .join('');
                }

                // GPU info
                document.getElementById('gpu-mem').textContent = data.gpuMemory ? data.gpuMemory + ' MB' : '—';
                document.getElementById('gpu-freq').textContent = data.gpuFreq ? (data.gpuFreq / 1e6).toFixed(0) + ' MHz' : '—';
                document.getElementById('gpu-codecs').textContent = Array.isArray(data.gpuCodecs) ? data.gpuCodecs.join(', ') : '—';

                // Power state
                const powerState = document.getElementById('power-state');
                if (data.throttled) {
                    const flags = parseThrottled(data.throttled);
                    powerState.innerHTML = Object.entries(flags)
                        .map(([key, active]) => `<span class="flag ${active ? 'warn' : 'ok'}">${key}</span>`)
                        .join(' ');
                } else {
                    powerState.textContent = '—';
                }

                // Throttled flags
                const flags = parseThrottled(data.throttled);
                const flagsEl = document.getElementById('throttled-flags');
                flagsEl.innerHTML = '';
                if (Object.keys(flags).length === 0) flagsEl.textContent = '—';
                else {
                    for (const [k, v] of Object.entries(flags)) {
                        const span = document.createElement('span');
                        span.className = 'flag ' + (v ? 'warn' : 'ok');
                        span.textContent = `${k}: ${v ? 'yes' : 'no'}`;
                        flagsEl.appendChild(span);
                    }
                }

                // Disk
                if (data.diskUsage) {
                    document.getElementById('disk-fs').textContent = data.diskUsage.filesystem || '—';
                    document.getElementById('disk-size').textContent = data.diskUsage.size || '—';
                    document.getElementById('disk-used').textContent = data.diskUsage.used || '—';
                    document.getElementById('disk-available').textContent = data.diskUsage.available || '—';
                    document.getElementById('disk-percent').textContent = data.diskUsage.percent || '—';
                }

                // Network
                const netIf = data.network || {};
                const ifaceNames = Object.keys(netIf).join(', ') || '—';
                document.getElementById('network-interfaces').textContent = ifaceNames;

                if (data.netTraffic) {
                    const parts = [];
                    for (const [iface, t] of Object.entries(data.netTraffic)) {
                        parts.push(`${iface}: RX ${t.rx} / TX ${t.tx}`);
                    }
                    document.getElementById('net-traffic').textContent = parts.join('\n');
                } else {
                    document.getElementById('net-traffic').textContent = '—';
                }
                document.getElementById('wireless').textContent = data.wirelessSignal !== null && data.wirelessSignal !== undefined ? data.wirelessSignal + ' dBm' : '—';

                // Processes
                if (Array.isArray(data.processes)) {
                    const p = data.processes.map(pr => `<div class="stat"><div>${pr.command} (pid:${pr.pid})</div><div>CPU:${pr.cpu}% MEM:${pr.mem}%</div></div>`).join('');
                    document.getElementById('processes').innerHTML = p;
                }

                // Hardware Info
                document.getElementById('pi-model').textContent = data.model || '—';
                document.getElementById('pi-revision').textContent = data.revision || '—';
                document.getElementById('pi-serial').textContent = data.serial || '—';

                // Format firmware info
                const firmwareInfo = document.getElementById('firmware-info');
                if (data.firmware) {
                    const fw = [];
                    if (data.firmware.bootloader) fw.push(`Bootloader: ${data.firmware.bootloader}`);
                    if (data.firmware.version) fw.push(`Version: ${data.firmware.version}`);
                    if (data.firmware.date) fw.push(`Date: ${data.firmware.date}`);
                    firmwareInfo.textContent = fw.join('\n');
                } else {
                    firmwareInfo.textContent = '—';
                }

                // Raw
                document.getElementById('raw').textContent = JSON.stringify(data, null, 2);

            } catch (err) {
                console.error('Failed to update dashboard', err);
            }
        }

        update();
        setInterval(update, 5000);
    </script>
</body>

</html>